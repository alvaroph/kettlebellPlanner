<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kettlebell Workout Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { transition: transform 0.2s; border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .difficulty-badge { position: absolute; top: 10px; right: 10px; }
        .block-container { background: #f1f3f5; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #0d6efd; }
        .exercise-row { background: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #dee2e6; display: flex; align-items: center; gap: 10px; }
        .exercise-inputs { flex-grow: 1; display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; }
        .delete-btn { color: #dc3545; cursor: pointer; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark sticky-top mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1"><i class="bi bi-activity"></i> KB Workout Editor</span>
        <div class="d-flex gap-2">
            <input type="file" id="fileInput" class="d-none" accept=".json">
            <button class="btn btn-outline-light" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-upload"></i> Subir JSON
            </button>
            <button class="btn btn-success" onclick="downloadJSON()">
                <i class="bi bi-download"></i> Descargar JSON
            </button>
            <button class="btn btn-primary" onclick="addNewWorkout()">
                <i class="bi bi-plus-circle"></i> Nuevo
            </button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row g-3 mb-4 bg-white p-3 rounded shadow-sm">
        <div class="col-md-4">
            <input type="text" id="searchFilter" class="form-control" placeholder="Buscar por título...">
        </div>
        <div class="col-md-3">
            <select id="categoryFilter" class="form-select">
                <option value="all">Todas las Categorías</option>
                </select>
        </div>
        <div class="col-md-3">
            <select id="difficultyFilter" class="form-select">
                <option value="all">Cualquier Dificultad</option>
                <option value="1">1 - Principiante</option>
                <option value="2">2 - Fácil</option>
                <option value="3">3 - Intermedio</option>
                <option value="4">4 - Avanzado</option>
                <option value="5">5 - Experto</option>
            </select>
        </div>
        <div class="col-md-2 text-end">
            <span class="badge bg-secondary" id="countBadge">0 entrenamientos</span>
        </div>
    </div>

    <div id="workoutsGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Entrenamiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Título</label>
                            <input type="text" class="form-control" id="editTitle">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Categoría</label>
                            <input type="text" class="form-control" id="editCategory" list="categoryOptions">
                            <datalist id="categoryOptions"></datalist>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fuente</label>
                            <input type="text" class="form-control" id="editSource">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Duración (min)</label>
                            <input type="number" class="form-control" id="editDuration">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Dificultad (1-5)</label>
                            <input type="number" class="form-control" id="editDifficulty" min="1" max="5">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Kettlebells</label>
                            <select class="form-select" id="editKettlebells">
                                <option value="single">Single</option>
                                <option value="double">Double</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Formato</label>
                            <input type="text" class="form-control" id="editFormat">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Consejos (Tips)</label>
                            <textarea class="form-control" id="editTips" rows="2"></textarea>
                        </div>
                    </div>

                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Bloques de Entrenamiento</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addBlock()">
                            <i class="bi bi-plus-square"></i> Añadir Bloque
                        </button>
                    </div>
                    
                    <div id="blocksContainer"></div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let workouts = []; // Aquí se almacenan los datos
    let currentEditIndex = -1;
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    // 1. Cargar Archivo
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                workouts = JSON.parse(e.target.result);
                renderApp();
                alert('Archivo cargado con éxito. ' + workouts.length + ' entrenamientos encontrados.');
            } catch (error) {
                alert('Error al leer el JSON: ' + error);
            }
        };
        reader.readAsText(file);
    });

    // 2. Renderizado Principal
    function renderApp() {
        populateFilters();
        renderGrid();
    }

    function populateFilters() {
        const categories = [...new Set(workouts.map(w => w.category))].sort();
        const select = document.getElementById('categoryFilter');
        const datalist = document.getElementById('categoryOptions');
        
        select.innerHTML = '<option value="all">Todas las Categorías</option>';
        datalist.innerHTML = '';

        categories.forEach(c => {
            select.innerHTML += `<option value="${c}">${c}</option>`;
            datalist.innerHTML += `<option value="${c}">`;
        });
    }

    function renderGrid() {
        const grid = document.getElementById('workoutsGrid');
        const search = document.getElementById('searchFilter').value.toLowerCase();
        const cat = document.getElementById('categoryFilter').value;
        const diff = document.getElementById('difficultyFilter').value;

        grid.innerHTML = '';
        
        const filtered = workouts.filter(w => {
            const matchesSearch = w.title.toLowerCase().includes(search) || (w.tips && w.tips.toLowerCase().includes(search));
            const matchesCat = cat === 'all' || w.category === cat;
            const matchesDiff = diff === 'all' || w.difficulty == diff;
            return matchesSearch && matchesCat && matchesDiff;
        });

        document.getElementById('countBadge').innerText = filtered.length + ' entrenamientos';

        filtered.forEach((w, index) => {
            // Mapear el índice original para edición
            const originalIndex = workouts.indexOf(w);
            
            const badgeColor = w.difficulty >= 4 ? 'bg-danger' : (w.difficulty === 3 ? 'bg-warning text-dark' : 'bg-success');
            
            const html = `
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <span class="badge ${badgeColor} difficulty-badge">Nivel ${w.difficulty}</span>
                            <h5 class="card-title text-primary">${w.title}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${w.category} | ${w.durationMinutes} min</h6>
                            <p class="card-text small text-truncate">${w.tips || 'Sin consejos...'}</p>
                            <ul class="list-unstyled small text-secondary">
                                <li><i class="bi bi-box-seam"></i> ${w.format}</li>
                                <li><i class="bi bi-person-arms-up"></i> ${w.kettlebells} KB</li>
                                <li><i class="bi bi-layers"></i> ${w.blocks ? w.blocks.length : 0} Bloques</li>
                            </ul>
                        </div>
                        <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${originalIndex})">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkout(${originalIndex})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            grid.innerHTML += html;
        });
    }

    // Listeners de filtros
    document.getElementById('searchFilter').addEventListener('input', renderGrid);
    document.getElementById('categoryFilter').addEventListener('change', renderGrid);
    document.getElementById('difficultyFilter').addEventListener('change', renderGrid);

    // 3. Lógica de Edición
    function openEditModal(index) {
        currentEditIndex = index;
        const w = workouts[index];

        // Llenar campos simples
        document.getElementById('editTitle').value = w.title || '';
        document.getElementById('editCategory').value = w.category || '';
        document.getElementById('editSource').value = w.source || '';
        document.getElementById('editDuration').value = w.durationMinutes || 0;
        document.getElementById('editDifficulty').value = w.difficulty || 1;
        document.getElementById('editKettlebells').value = w.kettlebells || 'single';
        document.getElementById('editFormat').value = w.format || '';
        document.getElementById('editTips').value = w.tips || '';

        // Llenar bloques (complejo)
        renderBlocksEditor(w.blocks || []);
        
        editModal.show();
    }

    function addNewWorkout() {
        // Crear plantilla vacía
        const newW = {
            title: "Nuevo Entrenamiento",
            category: "strength",
            kettlebells: "single",
            durationMinutes: 20,
            difficulty: 1,
            tips: "",
            format: "Sets/Reps",
            blocks: []
        };
        workouts.unshift(newW); // Añadir al inicio
        renderGrid();
        openEditModal(0);
    }

    function deleteWorkout(index) {
        if(confirm('¿Estás seguro de eliminar este entrenamiento?')) {
            workouts.splice(index, 1);
            renderApp();
        }
    }

    // 4. Renderizado Dinámico de Formulario (Bloques y Ejercicios)
    function renderBlocksEditor(blocks) {
        const container = document.getElementById('blocksContainer');
        container.innerHTML = '';

        blocks.forEach((block, bIndex) => {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'block-container';
            blockDiv.dataset.index = bIndex;

            let exercisesHtml = '';
            if (block.exercises) {
                block.exercises.forEach((ex, eIndex) => {
                    exercisesHtml += `
                        <div class="exercise-row" data-ex-index="${eIndex}">
                            <div class="exercise-inputs">
                                <input type="text" class="form-control form-control-sm ex-name" placeholder="Nombre" value="${ex.name || ''}">
                                <input type="text" class="form-control form-control-sm ex-reps" placeholder="Reps" value="${ex.reps || ''}">
                                <input type="text" class="form-control form-control-sm ex-sets" placeholder="Sets" value="${ex.sets || ''}">
                                <input type="text" class="form-control form-control-sm ex-side" placeholder="Side (each)" value="${ex.side || ''}">
                            </div>
                            <i class="bi bi-x-circle-fill delete-btn" onclick="removeExercise(this)"></i>
                        </div>
                    `;
                });
            }

            // Reglas especiales (para EMOM/AMRAP si existen)
            let rulesVal = block.rules ? JSON.stringify(block.rules).replace(/"/g, '&quot;') : '';

            blockDiv.innerHTML = `
                <div class="row mb-2">
                    <div class="col-md-4">
                        <label class="small">Tipo Bloque</label>
                        <select class="form-select form-select-sm block-type">
                            <option value="warmup" ${block.type === 'warmup' ? 'selected' : ''}>Warmup</option>
                            <option value="main" ${block.type === 'main' ? 'selected' : ''}>Main</option>
                            <option value="cooldown" ${block.type === 'cooldown' ? 'selected' : ''}>Cooldown</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small">Minutos</label>
                        <input type="number" class="form-control form-control-sm block-duration" value="${block.duration_minutes || 0}">
                    </div>
                    <div class="col-md-4">
                         <label class="small">Reglas (JSON opcional)</label>
                         <input type="text" class="form-control form-control-sm block-rules" value="${block.rules ? JSON.stringify(block.rules) : ''}" placeholder='{"style": "EMOM"}'>
                    </div>
                    <div class="col-md-1 text-end">
                        <label class="small d-block text-danger">Borrar</label>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock(this)"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <label class="small fw-bold">Ejercicios</label>
                <div class="exercises-list mb-2">${exercisesHtml}</div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addExercise(this)">+ Ejercicio</button>
            `;
            container.appendChild(blockDiv);
        });
    }

    // Funciones del DOM para el modal
    function addBlock() {
        const container = document.getElementById('blocksContainer');
        const emptyBlock = { type: 'main', duration_minutes: 10, exercises: [] };
        // Re-renderizar todo es ineficiente pero seguro para este ejemplo simple
        // Para hacerlo mejor, leemos el estado actual del DOM, añadimos y repintamos
        const currentData = scrapeBlocksFromDOM();
        currentData.push(emptyBlock);
        renderBlocksEditor(currentData);
    }

    function removeBlock(btn) {
        const blockDiv = btn.closest('.block-container');
        blockDiv.remove();
    }

    function addExercise(btn) {
        const list = btn.previousElementSibling;
        const div = document.createElement('div');
        div.className = 'exercise-row';
        div.innerHTML = `
            <div class="exercise-inputs">
                <input type="text" class="form-control form-control-sm ex-name" placeholder="Nombre">
                <input type="text" class="form-control form-control-sm ex-reps" placeholder="Reps">
                <input type="text" class="form-control form-control-sm ex-sets" placeholder="Sets">
                 <input type="text" class="form-control form-control-sm ex-side" placeholder="Side">
            </div>
            <i class="bi bi-x-circle-fill delete-btn" onclick="removeExercise(this)"></i>
        `;
        list.appendChild(div);
    }

    function removeExercise(btn) {
        btn.closest('.exercise-row').remove();
    }

    // 5. Guardar Cambios
    function saveChanges() {
        if (currentEditIndex === -1) return;

        const w = workouts[currentEditIndex];
        
        // Guardar campos simples
        w.title = document.getElementById('editTitle').value;
        w.category = document.getElementById('editCategory').value;
        w.source = document.getElementById('editSource').value;
        w.durationMinutes = parseInt(document.getElementById('editDuration').value) || 0;
        w.difficulty = parseInt(document.getElementById('editDifficulty').value) || 1;
        w.kettlebells = document.getElementById('editKettlebells').value;
        w.format = document.getElementById('editFormat').value;
        w.tips = document.getElementById('editTips').value;

        // Guardar bloques reconstruyéndolos desde el DOM
        w.blocks = scrapeBlocksFromDOM();

        editModal.hide();
        renderApp(); // Re-renderizar grid y filtros
    }

    function scrapeBlocksFromDOM() {
        const blocksData = [];
        const blockDivs = document.querySelectorAll('.block-container');
        
        blockDivs.forEach(div => {
            const type = div.querySelector('.block-type').value;
            const duration = parseInt(div.querySelector('.block-duration').value) || 0;
            const rulesStr = div.querySelector('.block-rules').value;
            let rules = undefined;
            
            try {
                if(rulesStr.trim()) rules = JSON.parse(rulesStr);
            } catch(e) { console.warn("JSON de reglas inválido, ignorando"); }

            const exercises = [];
            div.querySelectorAll('.exercise-row').forEach(exDiv => {
                const name = exDiv.querySelector('.ex-name').value;
                const reps = exDiv.querySelector('.ex-reps').value;
                const sets = exDiv.querySelector('.ex-sets').value;
                const side = exDiv.querySelector('.ex-side').value; // Nuevo campo capturado

                if (name) { // Solo guardar si tiene nombre
                    let exObj = { name, reps };
                    // Solo añadir sets/side si tienen valor para limpiar el JSON
                    if(sets) exObj.sets = isNaN(sets) ? sets : parseInt(sets);
                    if(side) exObj.side = side;
                    exercises.push(exObj);
                }
            });

            blocksData.push({
                type,
                duration_minutes: duration,
                rules,
                exercises
            });
        });
        return blocksData;
    }

    // 6. Descargar
    function downloadJSON() {
        const dataStr = JSON.stringify(workouts, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "workouts_modificados.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>